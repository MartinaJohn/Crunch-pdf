<!DOCTYPE html>
<html>
<head>
  <title>Encrypt and Compress File</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/zlib.js/0.2.11/zlib.min.js"></script>
</head>
<body>
  <input type="file" id="fileInput">
  <button onclick="encryptAndCompress()">Encrypt and Compress</button>

  <script>
    async function encryptAndCompress() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      const password = 'mySecretPassword';

      // Read the file into a buffer
      const data = await file.arrayBuffer();

      // Generate a random initialization vector (IV)
      const iv = crypto.getRandomValues(new Uint8Array(16));

      // Encrypt the data using AES-256-CBC cipher
      const algorithm = { name: 'AES-CBC', iv };
      const key = await crypto.subtle.importKey('raw', str2ab(password), algorithm, false, ['encrypt']);
      const encryptedData = await crypto.subtle.encrypt(algorithm, key, data);

      // Compress the encrypted data using zlib
      const compressedData = await new Promise((resolve, reject) => {
        zlib.gzip(encryptedData, (err, result) => {
          if (err) {
            reject(err);
          } else {
            resolve(result);
          }
        });
      });

      // Download the compressed and encrypted data
      const blob = new Blob([compressedData], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name + '.enc.gz';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      console.log('File encrypted and compressed successfully.');
    }

    function str2ab(str) {
      const buf = new ArrayBuffer(str.length);
      const bufView = new Uint8Array(buf);
      for (let i = 0; i < str.length; i++) {
        bufView[i] = str.charCodeAt(i);
      }
      return buf;
    }
  </script>
</body>
</html>
